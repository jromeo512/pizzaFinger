@{
    ViewData["Title"] = "Marcaje de Asistencia";
}

<div class="row">
    <div class="col-12 text-center mb-4">
        <h2><i class="fas fa-fingerprint"></i> Marcaje de Asistencia</h2>
        <p class="text-muted">Coloque su dedo en el lector de huellas</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-body p-5 text-center">
                <div id="statusArea">
                    <div id="waitingState">
                        <i class="fas fa-fingerprint fa-5x text-primary mb-3 pulse"></i>
                        <h4>Listo para escanear</h4>
                        <p class="text-muted">Coloque su dedo en el lector</p>
                        <button id="btnScan" class="btn btn-primary btn-lg mt-3">
                            <i class="fas fa-hand-pointer"></i> Iniciar Marcaje
                        </button>
                    </div>

                    <div id="processingState" style="display: none;">
                        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                        <h4>Procesando...</h4>
                        <p class="text-muted">Por favor espere</p>
                    </div>

                    <div id="resultState" style="display: none;">
                        <div id="resultIcon"></div>
                        <h4 id="resultMessage"></h4>
                        <div id="resultDetails" class="mt-3"></div>
                        <div id="fingerprintImage" class="mt-3"></div>
                        <button id="btnNewScan" class="btn btn-primary mt-3">
                            <i class="fas fa-redo"></i> Nuevo Marcaje
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body">
                <h5><i class="fas fa-clock"></i> Última sincronización</h5>
                <p id="lastSync" class="text-muted">--</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            let deviceReady = false;

            // Inicializar dispositivo al cargar
            initDevice();

            function initDevice() {
                $.post('/Operator/InitDevice', function (result) {
                    deviceReady = result.success;
                    if (!result.success) {
                        showError('Error al inicializar el lector: ' + result.message);
                    }
                });
            }

            $('#btnScan').click(function () {
                if (!deviceReady) {
                    showError('El lector no está inicializado. Recargue la página.');
                    return;
                }

                showProcessing();

                $.post('/Operator/CheckInOut', function (result) {
                    if (result.success) {
                        showSuccess(result);
                    } else {
                        showError(result.message);
                    }
                }).fail(function () {
                    showError('Error de conexión. Intente nuevamente.');
                });
            });

            $('#btnNewScan').click(function () {
                resetView();
            });

            function showProcessing() {
                $('#waitingState').hide();
                $('#resultState').hide();
                $('#processingState').show();
            }

            function showSuccess(result) {
                $('#processingState').hide();
                $('#resultState').show();

                let icon = result.type === 'checkin' 
                    ? '<i class="fas fa-check-circle fa-5x text-success mb-3"></i>'
                    : '<i class="fas fa-sign-out-alt fa-5x text-info mb-3"></i>';

                $('#resultIcon').html(icon);
                $('#resultMessage').text(result.message).addClass('text-success');

                let details = `
                    <div class="alert alert-info">
                        <h5><i class="fas fa-user"></i> ${result.data.nombre}</h5>
                        <p class="mb-1"><strong>Código:</strong> ${result.data.codigo}</p>
                        <p class="mb-1"><strong>Puesto:</strong> ${result.data.puesto || 'N/A'}</p>
                        <p class="mb-1"><strong>Entrada:</strong> ${result.data.horaEntrada || 'N/A'}</p>
                        ${result.data.horaSalida ? `<p class="mb-1"><strong>Salida:</strong> ${result.data.horaSalida}</p>` : ''}
                        ${result.data.tiempoExtra ? `<p class="mb-0"><strong>Tiempo Extra:</strong> ${result.data.tiempoExtra.toFixed(2)} hrs</p>` : ''}
                    </div>
                `;

                $('#resultDetails').html(details);

                // Mostrar imagen de huella si está disponible
                if (result.data.imageBase64) {
                    $('#fingerprintImage').html(`
                        <img src="data:image/bmp;base64,${result.data.imageBase64}" 
                             class="fingerprint-img" alt="Huella capturada" />
                    `);
                }

                // Audio de confirmación
                playBeep();

                // Auto-resetear después de 5 segundos
                setTimeout(resetView, 5000);
            }

            function showError(message) {
                $('#processingState').hide();
                $('#resultState').show();

                $('#resultIcon').html('<i class="fas fa-times-circle fa-5x text-danger mb-3"></i>');
                $('#resultMessage').text(message).addClass('text-danger');
                $('#resultDetails').html('');
                $('#fingerprintImage').html('');

                setTimeout(resetView, 3000);
            }

            function resetView() {
                $('#resultState').hide();
                $('#processingState').hide();
                $('#waitingState').show();
                $('#resultMessage').removeClass('text-success text-danger');
            }

            function playBeep() {
                // Beep de confirmación
                let audioContext = new (window.AudioContext || window.webkitAudioContext)();
                let oscillator = audioContext.createOscillator();
                oscillator.frequency.value = 800;
                oscillator.connect(audioContext.destination);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            }

            // Actualizar hora cada segundo
            setInterval(function () {
                let now = new Date();
                $('#lastSync').text(now.toLocaleString('es-GT'));
            }, 1000);
        });
    </script>

    <style>
        .pulse {
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
}
